{%- comment -%}
  Renders a product card for collection grids and featured collections.
  Expects: product (product object)

  Layout: thumbnail → meta row (collection + variant swatch) → title + price
  Sold-out state: thumbnail at 50% opacity, price struck through, "SOLD OUT" label.
{%- endcomment -%}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign is_bundle = false
  if product.tags contains 'bundle' or product.type == 'Bundle'
    assign is_bundle = true
  endif
-%}

<article class="product-card{% unless product.available %} sold-out{% endunless %}">
  <a href="{{ product.url }}" class="product-card-link">
    <div class="product-card-thumbnail">
      {%- if product.featured_image -%}
        {{
          product.featured_image
          | image_url: width: 1200
          | image_tag:
            loading: 'lazy',
            sizes: '(min-width: 1200px) 25vw, (min-width: 900px) 33vw, (min-width: 600px) 50vw, 100vw',
            width: product.featured_image.width,
            height: product.featured_image.height
        }}

        {%- if product.media.size > 1 and product.media[1].media_type == 'image' -%}
          {{
            product.media[1]
            | image_url: width: 1200
            | image_tag:
              loading: 'lazy',
              sizes: '(min-width: 1200px) 25vw, (min-width: 900px) 33vw, (min-width: 600px) 50vw, 100vw',
              width: product.media[1].width,
              height: product.media[1].height,
              class: 'product-card-hover-image'
          }}
        {%- endif -%}
      {%- else -%}
        <div class="product-card-placeholder"></div>
      {%- endif -%}

      {%- comment -%}
        Badge priority: Sale > New. Only one badge renders.
        Sold-out state is handled via the label in the price row, not a badge.
      {%- endcomment -%}
      {%- liquid
        assign badge_text = ''
        assign badge_type = ''

        if product.available and product.compare_at_price > product.price
          assign badge_text = 'products.product.sale' | t
          assign badge_type = 'sale'
        endif

        if badge_text == '' and product.available
          assign now_s = 'now' | date: '%s' | plus: 0
          assign created_s = product.created_at | date: '%s' | plus: 0
          assign age_days = now_s | minus: created_s | divided_by: 86400
          if age_days <= 30
            assign badge_text = 'products.product.new' | t
            assign badge_type = 'new'
          endif
        endif
      -%}

      {%- if badge_text != '' -%}
        <span class="product-card-badge {{ badge_type }}">{{ badge_text }}</span>
      {%- endif -%}
    </div>

    <div class="product-card-meta">
      <span class="product-card-collection">
        {%- if is_bundle -%}
          Set
        {%- elsif product.metafields.custom.color_collection != blank -%}
          {{ product.metafields.custom.color_collection }}
        {%- else -%}
          {{ product.collections.first.title | default: product.type }}
        {%- endif -%}
      </span>
      {%- unless is_bundle -%}
        {%- if current_variant.title != 'Default Title' -%}
          <span class="product-card-variant">
            {%- assign hex_color = current_variant.metafields.custom.hex_color.value -%}
            {%- if hex_color != blank -%}
              <span class="product-card-swatch" style="--hex: {{ hex_color }}"></span>
            {%- endif -%}
            {{ current_variant.title | downcase }}
          </span>
        {%- endif -%}
      {%- endunless -%}
    </div>

    <div class="product-card-info">
      <h3 class="product-card-title">{{ product.title }}</h3>
      {% render 'product-price', product: product %}
    </div>
  </a>
</article>

{% stylesheet %}
  .product-card {
    display: grid;
    gap: var(--spacing-1);
    align-content: start;
  }

  .product-card-link {
    display: grid;
    gap: var(--spacing-1);
    align-content: start;
  }

  /* Thumbnail */
  .product-card-thumbnail {
    position: relative;
    overflow: hidden;
    aspect-ratio: 3 / 4;
    background-color: var(--color-input-bg);
    transition: background-color var(--transition-base);
  }

  .product-card-thumbnail:hover {
    background-color: var(--color-input-bg-hover);
  }

  .product-card-thumbnail:active {
    background-color: var(--color-input-bg-pressed);
  }

  .product-card-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-card-hover-image {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity var(--transition-base);
  }

  @media (hover: hover) {
    .product-card:hover .product-card-hover-image {
      opacity: 1;
    }
  }

  .product-card-placeholder {
    width: 100%;
    height: 100%;
    background: var(--color-input-bg);
  }

  /* Badge */
  .product-card-badge {
    position: absolute;
    top: var(--spacing-1);
    right: var(--spacing-1);
    background: black;
    color: white;
    font-size: var(--font-detail-size);
    padding: 2px 4px;
  }

  .product-card-badge.sale {
    background: var(--color-accent);
  }

  /* Meta row: collection + variant swatch */
  .product-card-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .product-card-collection {
    color: var(--color-text-muted);
    font-size: var(--font-detail-size);
  }

  .product-card-variant {
    color: var(--color-text-muted);
    font-size: var(--font-detail-size);
    display: flex;
    align-items: center;
  }

  .product-card-swatch {
    background-color: var(--hex);
    height: 8px;
    width: 8px;
    margin-right: 6px;
    border: 1px solid hsla(0, 0%, 0%, 0.1);
    display: inline-block;
    flex-shrink: 0;
  }

  /* Info: title + price */
  .product-card-info {
    display: grid;
    gap: var(--spacing-1);
  }

  .product-card-title {
    font-size: var(--font-base-size);
  }

  /* Sold-out state */
  .product-card.sold-out .product-card-thumbnail {
    opacity: 0.5;
  }

  @media (prefers-reduced-motion: reduce) {
    .product-card-hover-image {
      transition: none;
    }
    .product-card-thumbnail {
      transition: none;
    }
  }
{% endstylesheet %}
